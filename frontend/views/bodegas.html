<div class="content-wrapper">
  <div class="page-header">
    <h3 class="page-title">Almacenamiento Inteligente (WMS)</h3>
  </div>

  <style>
    .silo-tank {
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    .silo-fill {
      border-top: 1px solid rgba(255,255,255,0.3);
    }
    .blink {
      animation: blink-animation 1s steps(5, start) infinite;
    }
    @keyframes blink-animation {
      to { visibility: hidden; }
    }
    .bottom-0 { bottom: 0; }
  </style>

  <div class="row">
    <div class="col-md-12 grid-margin">
      <div class="card">
        <div class="card-body">
          <ul class="nav nav-tabs" id="wmsTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="mapa-tab" data-toggle="tab" href="#wmsMapa" role="tab" aria-controls="wmsMapa" aria-selected="true">Mapa de Silos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="pendientes-tab" data-toggle="tab" href="#wmsPendientes" role="tab" aria-controls="wmsPendientes" aria-selected="false">Descargar Camión <span id="badgePendientes" class="badge badge-pill badge-danger d-none">0</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="lotes-tab" data-toggle="tab" href="#wmsLotes" role="tab" aria-controls="wmsLotes" aria-selected="false">Lotes (Trazabilidad)</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="movimientos-tab" data-toggle="tab" href="#wmsMovimientos" role="tab" aria-controls="wmsMovimientos" aria-selected="false">Movimientos / Kardex</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="operaciones-tab" data-toggle="tab" href="#wmsOperaciones" role="tab" aria-controls="wmsOperaciones" aria-selected="false">Operaciones</a>
            </li>
          </ul>

          <div class="tab-content mt-3" id="wmsTabsContent">
            <!-- TAB MAPA SILOS -->
            <div class="tab-pane fade show active" id="wmsMapa" role="tabpanel" aria-labelledby="mapa-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">Mapa de Silos por Sucursal</h4>
                <div class="form-inline">
                  <label class="mr-2 mb-0">Sucursal:</label>
                  <select id="wmsSucursalMapa" class="form-control">
                    <option value="">Todas</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped table-bordered d-none" id="tablaMapaSilos">
                  <thead>
                    <tr>
                      <th>Sucursal</th>
                      <th>Bodega</th>
                      <th>Silo</th>
                      <th>Producto</th>
                      <th>Capacidad (kg)</th>
                      <th>Nivel actual (kg)</th>
                      <th>Ocupación</th>
                      <th>Alerta</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <!-- Vista Visual de Silos -->
              <div id="visualSilosContainer" class="row mt-4">
                <!-- Se llena dinámicamente -->
              </div>
            </div>

            <!-- TAB PENDIENTES (DESCARGA) -->
            <div class="tab-pane fade" id="wmsPendientes" role="tabpanel" aria-labelledby="pendientes-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">Recepciones con análisis (Listas para Silo)</h4>
                <button id="btnRefrescarPendientes" class="btn btn-outline-secondary btn-sm"><i class="fas fa-sync"></i> Actualizar</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover" id="tablaPendientes">
                  <thead>
                    <tr>
                      <th>ID Rec.</th>
                      <th>Fecha</th>
                      <th>Tipo</th>
                      <th>Origen/Contraparte</th>
                      <th>Producto</th>
                      <th>Neto Aceptado (kg)</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- TAB LOTES -->
            <div class="tab-pane fade" id="wmsLotes" role="tabpanel" aria-labelledby="lotes-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">Lotes activos y su ubicación</h4>
                <div class="form-inline">
                  <label class="mr-2 mb-0">Filtrar por Silo:</label>
                  <select id="wmsFiltroSiloLotes" class="form-control">
                    <option value="">Todos</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped" id="tablaLotes">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Código lote</th>
                      <th>Recepción</th>
                      <th>Proveedor</th>
                      <th>Producto</th>
                      <th>Sucursal / Bodega / Silo</th>
                      <th>Inicial (kg)</th>
                      <th>Actual (kg)</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- TAB MOVIMIENTOS / KARDEX -->
            <div class="tab-pane fade" id="wmsMovimientos" role="tabpanel" aria-labelledby="movimientos-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">Kardex de Movimientos</h4>
                <div class="form-inline">
                  <select id="wmsFiltroSiloMov" class="form-control mr-2">
                    <option value="">Silo (todos)</option>
                  </select>
                  <select id="wmsFiltroLoteMov" class="form-control">
                    <option value="">Lote (todos)</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped" id="tablaMovimientos">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Tipo</th>
                      <th>Sucursal</th>
                      <th>Silo origen</th>
                      <th>Silo destino</th>
                      <th>Lote</th>
                      <th>Cantidad (kg)</th>
                      <th>Observación</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- TAB OPERACIONES -->
            <div class="tab-pane fade" id="wmsOperaciones" role="tabpanel" aria-labelledby="operaciones-tab">
              <h4 class="card-title mb-3">Operaciones de Almacenamiento</h4>

              <div class="alert alert-info">
                Este módulo conecta la recepción con el almacenamiento en silos.
                Crea lotes desde recepciones, realiza trasiegos entre silos y registra mezclas.
              </div>

              <div class="row">
                <!-- Crear lote desde recepción -->
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Crear lote desde recepción</h5>
                      <div class="form-group">
                        <label>Código de Ticket / ID Recepción</label>
                        <input id="wmsRecepcionId" type="text" class="form-control" placeholder="Escanee el ticket o ingrese ID" />
                        <small class="form-text text-muted">Escanee el código de barras del ticket pesado y analizado.</small>
                      </div>
                      <div class="form-group">
                        <label>Silo destino</label>
                        <select id="wmsSiloDestino" class="form-control"></select>
                      </div>
                      <div class="form-group">
                        <label>Cantidad (kg)</label>
                        <input id="wmsCantidadLote" type="number" class="form-control" placeholder="Dejar vacío para usar neto de recepción" />
                      </div>
                      <div class="form-group">
                        <label>Código de lote (opcional)</label>
                        <input id="wmsCodigoLote" class="form-control" placeholder="Si se deja en blanco se genera automáticamente" />
                      </div>
                      <div class="form-group">
                        <label>Observación</label>
                        <input id="wmsObsLote" class="form-control" />
                      </div>
                      <button id="btnCrearLote" class="btn btn-primary">Crear lote</button>
                    </div>
                  </div>
                </div>

                <!-- Trasiego entre silos -->
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Trasiego entre silos</h5>
                      <div class="form-group">
                        <label>Lote</label>
                        <select id="wmsLoteTrasiego" class="form-control"></select>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label>Silo origen</label>
                          <select id="wmsSiloOrigenTrasiego" class="form-control"></select>
                        </div>
                        <div class="form-group col-md-6">
                          <label>Silo destino</label>
                          <select id="wmsSiloDestinoTrasiego" class="form-control"></select>
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Cantidad (kg)</label>
                        <input id="wmsCantidadTrasiego" type="number" class="form-control" />
                      </div>
                      <div class="form-group">
                        <label>Observación</label>
                        <input id="wmsObsTrasiego" class="form-control" />
                      </div>
                      <button id="btnTrasiego" class="btn btn-secondary">Registrar trasiego</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <!-- Mezcla (Blending) -->
                <div class="col-md-12">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Mezcla (Blending)</h5>
                      <p class="text-muted">Registra una mezcla de dos lotes para crear un nuevo lote en un silo destino.</p>

                      <div class="form-row">
                        <div class="form-group col-md-3">
                          <label>Lote origen A</label>
                          <select id="wmsLoteOrigenA" class="form-control"></select>
                        </div>
                        <div class="form-group col-md-3">
                          <label>Cantidad A (kg)</label>
                          <input id="wmsCantidadA" type="number" class="form-control" />
                        </div>
                        <div class="form-group col-md-3">
                          <label>Lote origen B</label>
                          <select id="wmsLoteOrigenB" class="form-control"></select>
                        </div>
                        <div class="form-group col-md-3">
                          <label>Cantidad B (kg)</label>
                          <input id="wmsCantidadB" type="number" class="form-control" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-4">
                          <label>Silo destino</label>
                          <select id="wmsSiloDestinoMezcla" class="form-control"></select>
                        </div>
                        <div class="form-group col-md-4">
                          <label>Código nuevo lote (opcional)</label>
                          <input id="wmsCodigoMezcla" class="form-control" />
                        </div>
                        <div class="form-group col-md-4">
                          <label>Observación</label>
                          <input id="wmsObsMezcla" class="form-control" />
                        </div>
                      </div>

                      <button id="btnMezcla" class="btn btn-info">Registrar mezcla</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DESCARGA CAMION (ASIGNAR SILO) -->
<div class="modal fade" id="modalDescargaSilo" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Descargar Camión a Silo</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-light border">
          <p class="mb-1"><strong>Recepción:</strong> <span id="modalDescargaRecId"></span></p>
          <p class="mb-1"><strong>Producto:</strong> <span id="modalDescargaProducto"></span></p>
        </div>
        <form id="formDescargaSilo">
          <input type="hidden" id="modalDescargaInputRecId">
          <div class="form-group">
            <label>Cantidad a descargar (kg)</label>
            <input type="number" id="modalDescargaInputCantidad" class="form-control" min="0.01" step="0.01" placeholder="Ingrese los kg" required>
            <small class="form-text text-muted">Puede corregir el valor si la recepción no tiene peso neto registrado.</small>
          </div>
          <div class="form-group">
            <label>Seleccione Silo Destino</label>
            <select id="modalDescargaSelectSilo" class="form-control" required></select>
          </div>
          <div class="form-group">
            <label>Observación</label>
            <textarea id="modalDescargaObservacion" class="form-control" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" id="btnConfirmarDescarga" class="btn btn-primary">Registrar Descarga</button>
      </div>
    </div>
  </div>
</div>
